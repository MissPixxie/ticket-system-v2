// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  // NOTE: When using mysql or sqlserver, uncomment the @db.Text annotations in model Account below
  // Further reading:
  // https://next-auth.js.org/adapters/prisma#create-the-prisma-schema
  // https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference#string
}

enum Department {
  IT
  HR
  CAMPAIGN
  PRODUCT
  CUSTOMERCLUB
}

enum Status {
  OPEN
  IN_PROGRESS
  CLOSED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ActionType {
  CREATED
  UPDATED
  STATUS_CHANGED
  ASSIGNED
  UNASSIGNED
  NOTE_ADDED
}

enum MessageType {
  USER_MESSAGE
  HANDLER_MESSAGE
  SYSTEM_MESSAGE
}

model Action {
  id              String         @id @default(cuid())
  user            User           @relation(fields: [userId], references: [id])
  userId          String
  actionType      ActionType
  timestamp       DateTime       @default(now())
  ticketHistory   TicketHistory? @relation(fields: [ticketHistoryId], references: [id])
  ticketHistoryId String?

  @@unique([id])
}

model Role {
  id          String       @id @default(cuid())
  name        String       @unique
  permissions Permission[]
  users       User[]
}

model Permission {
  id     String  @id @default(cuid())
  name   String
  role   Role?   @relation(fields: [roleId], references: [id])
  roleId String?

  @@unique([name])
}

model Ticket {
  id         String     @id @default(cuid())
  title      String
  issue      String
  image      String?
  department Department
  status     Status     @default(OPEN)
  priority   Priority   @default(LOW)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  solvedAt   DateTime?

  createdBy    User    @relation("TicketsCreated", fields: [createdById], references: [id])
  createdById  String
  assignedTo   User?   @relation("TicketsHandled", fields: [assignedToId], references: [id])
  assignedToId String?

  ticketHistories TicketHistory[]
  messages        Message[]
  user            User?           @relation(fields: [userId], references: [id])
  userId          String?

  @@unique([id])
}

model TicketHistory {
  id        String   @id @default(cuid())
  ticket    Ticket   @relation(fields: [ticketId], references: [id])
  ticketId  String
  actions   Action[]
  timestamp DateTime @default(now())

  @@unique([id])
}

model Message {
  id        String      @id @default(cuid())
  message   String
  type      MessageType @default(USER_MESSAGE)
  createdAt DateTime    @default(now())

  createdBy   User   @relation(fields: [createdById], references: [id])
  createdById String

  ticket   Ticket @relation(fields: [ticketId], references: [id])
  ticketId String

  @@unique([id])
}

model Post {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdBy   User   @relation(fields: [createdById], references: [id])
  createdById String

  @@index([name])
}

// Necessary for Next auth
model Account {
  id                       String   @id @default(cuid())
  accountId                String   @unique
  userId                   String
  type                     String?
  provider                 String?
  providerId               String?
  password                 String?
  createdAt                DateTime
  updatedAt                DateTime
  refresh_token            String? // @db.Text
  access_token             String? // @db.Text
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String? // @db.Text
  session_state            String?
  user                     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refresh_token_expires_in Int?

  @@index([userId])
  @@index([accountId, providerId])
}

// model Account {
//   id                       String  @id @default(cuid())
//   userId                   String
//   type                     String?
//   provider                 String?
//   providerAccountId        String?
//   refresh_token            String? // @db.Text
//   access_token             String? // @db.Text
//   expires_at               Int?
//   token_type               String?
//   scope                    String?
//   id_token                 String? // @db.Text
//   session_state            String?
//   user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
//   refresh_token_expires_in Int?

//   @@unique([provider, providerAccountId])
// }

// model Session {
//   id           String   @id @default(cuid())
//   sessionToken String   @unique
//   userId       String
//   expires      DateTime
//   user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
// }

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime
  updatedAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id             String    @id @default(cuid())
  name           String?
  email          String?   @unique
  password       String?
  emailVerified  Boolean?  @default(false)
  image          String?
  role           Role?     @relation(fields: [roleId], references: [id])
  roleId         String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now()) @updatedAt
  sessions       Session[]
  accounts       Account[]
  ticketsCreated Ticket[]  @relation("TicketsCreated")
  ticketsHandled Ticket[]  @relation("TicketsHandled")
  messages       Message[]
  tickets        Ticket[]
  posts          Post[]
  actions        Action[]
}

// model VerificationToken {
//   identifier String
//   token      String   @unique
//   expires    DateTime

//   @@unique([identifier, token])
// }

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime
  updatedAt  DateTime

  @@index([identifier])
}
